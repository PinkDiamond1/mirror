var detectMetamask=!1,metamaskConnected=!1,userAddress="",eth_price=new BigNumber(0),gas_price_eth=new BigNumber(0),withdraw_note="",global_objects={},deposit_gas_units=new BigNumber(12e5),withdraw_gas_units=new BigNumber(5e5),proxyAddress="0xb5fc86A50ad433fff6c2E3840409A3432858923f",apiURL="../../api/requests/",contract_viewallowance="dd62ed3e",contract_approve="095ea7b3",contract_depositDAI="8c678254",contract_depositUSDC="7c34c355",contract_depositUSDT="9bb0b783",contract_withdrawDAI="7bd0d2af",contract_withdrawUSDC="2db80eb1",contract_withdrawUSDT="4fdc0c90",contract_getPoolInfo="35efa0f8",targetNetwork=1;$(window).on("load",function(){checkMetaMaskExist(),$("#accounts_header").html("Connect to MetaMask to view the accounts"),$("#deposit_account").change(function(){$("#deposit_action_buttons").hide(),$("#unlock_button").hide(),$("#note").html(""),$("#note_field").hide();var e=$("#deposit_account").children("option:selected").val();$("#unlock_inner_button").html("UNLOCK "+e.toUpperCase()+" TO DEPOSIT >"),$("#deposit_gen_tran_button").html("GENERATE NOTE >"),$("#deposit_options").show(),$("#100_unit").html(e.toUpperCase()),$("#1000_unit").html(e.toUpperCase()),checkAllowance(),checkPoolInfo()})});var tokenList=[];function loadTokenList(){tokenList.push({token:"0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",units:"USDC",decimals:6}),tokenList.push({token:"0x6B175474E89094C44Da98b954EedeAC495271d0F",units:"DAI",decimals:18}),tokenList.push({token:"0xdAC17F958D2ee523a2206206994597C13D831ec7",units:"USDT",decimals:6})}function checkMetaMaskExist(){void 0!==window.ethereum&&(1==ethereum.isMetaMask&&(detectMetamask=!0,null==getCookie("metamask")?$("#metamask_interactive").html("Connect MetaMask"):0==metamaskConnected&&enableMetaMask()))}async function enableMetaMask(){const e=await ethereum.request({method:"eth_requestAccounts"});if(e){if(ethereum.chainId||(ethereum.chainId="0x1"),0!=new BigNumber("0x"+ethereum.chainId.substring(2)).comparedTo(targetNetwork))return void alert("This application requires the main network, please switch it in your MetaMask UI.");userAddress=e[0],metamaskConnected=!0,setCookie("metamask","active",0),window.location.href.indexOf("mirror")>-1&&(apiURL="https://www.stabilize.finance/api/requests/"),$("#loading_panel").hide(),$("#data_panel").show(),matchColumnLength(),refreshAccountData(),loadWithdrawRequests(0),$("#metamask_interactive").html(userAddress.substring(0,9)+"..."+userAddress.substring(33)),ethereum.on("accountsChanged",function(e){userAddress=e[0],$("#metamask_interactive").html(userAddress.substring(0,9)+"..."+userAddress.substring(33)),location.reload()}),ethereum.on("chainChanged",function(e){location.reload()})}}function metamaskButtonClick(){if(0==detectMetamask)window.open("https://metamask.io/","_blank");else 1==detectMetamask&&0==metamaskConnected&&enableMetaMask()}function padleftzero(e,t){return(e=e.toString()).length<t?padleftzero("0"+e,t):e}function padrightzero(e,t){return(e=e.toString()).length<t?padrightzero(e+"0",t):e}function matchColumnLength(){if("0px"!=$("#request_column").css("borderLeftWidth")){var e=parseFloat($("#request_column").css("height")),t=parseFloat($("#teller_column").css("height"));e<t&&$("#request_column").css("min-height",t)}}function getEthereumGasPrice(){$.get("https://www.etherchain.org/api/gasPriceOracle",function(e){e&&(gas_price_eth=new BigNumber(e.standard).div(1e9))})}function getEtherPrice(){$.get("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd",function(e){e&&(eth_price=new BigNumber(e.ethereum.usd))})}function getCoinPriceWithdraw(e,t){var r="dai";"usdc"==e?r="usd-coin":"usdt"==e&&(r="tether");var i="https://api.coingecko.com/api/v3/simple/price?ids="+r+"&vs_currencies=usd";$.get(i,function(e){e&&(price=new BigNumber(e[r].usd),calculateWithdrawFee(price,t))})}function calculateWithdrawFee(e,t){var r=new BigNumber(t),i=new BigNumber(0),o=new BigNumber(.01),n=new BigNumber(.001),s=new BigNumber(1.02),a=new BigNumber(.98);if(e.comparedTo(a)<=0)i=o;else if(e.comparedTo(s)>=0)i=n;else{var d=o.minus(n).div(s.minus(a)),u=e.minus(a).times(d);i=new BigNumber(o).minus(u)}r=(r=r.times(i)).plus(10),r=new BigNumber(r.integerValue(BigNumber.ROUND_CEIL)),$("#withdraw_fee").html(r.dp(0).toString(10))}function performDepositAction(){if("none"==$("#note_field").css("display")){if(null==global_objects.web3_instance)return;var e=$("#deposit_account").children("option:selected").val().toLowerCase(),t=100;1==$("#deposit_1000").prop("checked")&&(t=1e3);var r=global_objects.generateDepositNote(e,t,targetNetwork);$("#note").html(r),$("#deposit_options").hide(),$("#note_field").show(),$("#deposit_gen_tran_button").html("DEPOSIT >")}else{r=$("#note").text(),t=new BigNumber(100);1==$("#deposit_1000").prop("checked")&&(t=new BigNum(1e3));e=$("#deposit_account").children("option:selected").val().toLowerCase();for(var i=-1,o=0;o<tokenList.length;o++)if(tokenList[o].units.toLowerCase()==e){i=o;break}if(-1==i)return;t=t.times(new BigNumber(10).pow(tokenList[i].decimals));var n=contract_depositDAI;"usdc"==e?n=contract_depositUSDC:"usdt"==e&&(n=contract_depositUSDT);var s=global_objects.createDepositCommitment(r).substring(2);s=padrightzero(s,64);var a=t.toString(16);a=padleftzero(a,64),sendETHTransaction([{to:proxyAddress,gas:deposit_gas_units.toString(16),from:userAddress,data:"0x"+n+s+a}],function(){$("#note").html(""),$("#note_field").hide(),$("#deposit_gen_tran_button").html("GENERATE NOTE >"),$("#deposit_options").show()})}}function executeWithdraw(e){if(null==global_objects.web3_instance)return void alert("Security modules not loaded yet");var t=$("#request_"+e+"_proof").val(),r=$("#request_"+e+"_root").val(),i=$("#request_"+e+"_recipient").val(),o=proxyAddress,n=new BigNumber($("#request_"+e+"_ethfee").val()),s=new BigNumber($("#request_"+e+"_reward").val()),a=$("#request_"+e+"_currency").val().toLowerCase(),d=new BigNumber($("#request_"+e+"_amount").val());n=n.times(new BigNumber(10).pow(18));for(var u=-1,c=0;c<tokenList.length;c++)if(tokenList[c].units.toLowerCase()==a){u=c;break}if(-1==u)return;s=s.times(new BigNumber(10).pow(tokenList[u].decimals)),d=d.times(new BigNumber(10).pow(tokenList[u].decimals));var l=global_objects.web3_instance.eth.abi.encodeParameters(["bytes","uint256","bytes32","bytes32","address","address","uint256","uint256"],[t,d.toString(10),r,e,i,o,s.toString(10),n.toString(10)]);l=l.substring(2);var h=contract_withdrawDAI;"usdc"==a?h=contract_withdrawUSDC:"usdt"==a&&(h=contract_withdrawUSDT),sendETHTransaction([{to:proxyAddress,gas:withdraw_gas_units.toString(16),value:n.toString(16),from:userAddress,data:"0x"+h+l}],function(){removeWithdrawRequest(e)})}function removeWithdrawRequest(e){$("#request_"+e).remove()}function processNote(){if(null!=global_objects.web3_instance&&!((withdraw_note=$("#deposit_note_withdraw").val().trim()).length<5))try{var{currency:e,amount:t,netId:r,deposit:i}=global_objects.parseNote(withdraw_note);if("dai"!=e.toLowerCase()&&"usdc"!=e.toLowerCase()&&"usdt"!=e.toLowerCase())return;$("#withdraw_account").html(e.toUpperCase()),$("#tip_coin").html(e.toUpperCase()),$("#withdraw_amount").html(t),$("#withdraw_fee").html(""),getCoinPriceWithdraw(e.toLowerCase(),t),$("#deposit_note_withdraw").val(""),$("#start_withdraw_div").hide(),$("#finish_withdraw_div").show(),matchColumnLength()}catch{alert("Failed to parse deposit note")}}async function postProof(){var e=$("#withdraw_address").val().trim();if(42==e.length){if(0!=$("#withdraw_fee").text().length){var t=new BigNumber($("#withdraw_eth").val()),r=new BigNumber($("#withdraw_tip").val());if((r=r.plus($("#withdraw_fee").text())).comparedTo(t.times(eth_price))<0)alert("Your tip amount is not high enough to cover your ETH requested");else if(r.comparedTo(new BigNumber($("#withdraw_amount").text()))>=0)alert("Your tip amount cannot be greater than or equal to the amount withdrawn");else{if(withdraw_gas_units.times(gas_price_eth).times(eth_price).comparedTo(r)>0)if(0==confirm("This request is not economic for the withdrawer due to gas cost, it may never be fulfilled. Consider giving more tips. Do you want to continue?"))return;$("#withdraw_button").html("REQUESTING WITHDRAW..."),$("#withdraw_button").css("disabled",!0),$("#withdraw_code").html("<br>This may take a few minutes as a zkSnark proof needs to be generated.<br>"),$("#withdraw_code").show();try{console.log("Generating proof in the browser");const{proof:c,args:l}=await global_objects.generateWithdrawalProof(withdraw_note,e,proxyAddress,r.dp(3).toString(10),t.dp(18).toString(10));for(var i=$("#withdraw_account").text().toLowerCase(),o=-1,n=0;n<tokenList.length;n++)if(tokenList[n].units.toLowerCase()==i){o=n;break}if(-1==o)return;var s=new BigNumber($("#withdraw_amount").text());s=s.times(new BigNumber(10).pow(tokenList[o].decimals));var a=r.times(new BigNumber(10).pow(tokenList[o].decimals)),d=t.times(new BigNumber(10).pow(18)),u=global_objects.web3_instance.eth.abi.encodeParameters(["bytes","uint256","bytes32","bytes32","address","address","uint256","uint256"],[c,s.dp(0).toString(10),l[0],l[1],l[2],l[3],a.dp(0).toString(10),d.dp(0).toString(10)]);$.post(apiURL,{request_type:"add_new",currency:i,abi:u,proof:c,root:l[0],nullifierHash:l[1],recipient:l[2],fee:a.toString(16),eth_refund:d.toString(16),amount:s.toString(16)},function(e){e?void 0!==e.error?($("#withdraw_code").html("<br>"+e.error+"<br>"),$("#withdraw_button").html("REQUEST WITHDRAW >"),$("#withdraw_button").css("disabled",!1)):($("#withdraw_button").html("DONE"),$("#withdraw_code").html("<br>Withdraw request posted/updated successfully<br>"),window.setTimeout(function(){loadWithdrawRequests(0),resetWithdrawWindow()},5e3)):($("#withdraw_code").html("<br>Failed to get a response from server<br>"),$("#withdraw_button").html("REQUEST WITHDRAW >"),$("#withdraw_button").css("disabled",!1))})}catch(e){alert("Failed to generate proof: "+e),resetWithdrawWindow()}}}}else alert("Ethereum address is invalid")}function resetWithdrawWindow(){$("#finish_withdraw_div").hide(),$("#start_withdraw_div").show(),$("#withdraw_eth").val("0"),$("#withdraw_tip").val("0"),$("#deposit_note_withdraw").val(""),$("#withdraw_button").html("REQUEST WITHDRAW >"),$("#withdraw_code").hide(),$("#withdraw_button").css("disabled",!1),withdraw_note=""}function checkPoolInfo(){var e=$("#deposit_account").children("option:selected").val().toLowerCase(),t=0;"usdc"==e?t=1:"usdt"==e&&(t=2);for(var r=-1,i=0;i<tokenList.length;i++)if(tokenList[i].units.toLowerCase()==e){r=i;break}if(-1==r)return;var o=(t=new BigNumber(t)).toString(16);o=padleftzero(o,64);const n=[{to:proxyAddress,data:"0x"+contract_getPoolInfo+o},"latest"];ethereum.request({method:"eth_call",params:n}).then(e=>{var t=e.substring(2),i=new BigNumber("0x"+t.substring(0,64)),o=new BigNumber("0x"+t.substring(64,128)),n=new BigNumber("0x"+t.substring(128,192)),s=new BigNumber("0x"+t.substring(192,256)),a=new BigNumber("0x"+t.substring(256,320));i=i.div(new BigNumber(10).pow(tokenList[r].decimals)),$("#deposit_total").html(i.dp(4).toString(10)+" "+tokenList[r].units),$("#deposit_num_100").html(o.toString(10)),$("#deposit_num_1000").html(n.toString(10));var d=Math.floor((new Date).getTime()/1e3);if(s.comparedTo(0)>0){var u=d-parseInt(s.toString(10)),c=Math.floor(u/3600),l=Math.floor(u%3600/60),h="HRS";1==c&&(h="HR"),c>0?$("#deposit_time_100").html(c+" "+h+", "+l+" MINS AGO"):$("#deposit_time_100").html(l+" MINS AGO")}else $("#deposit_time_100").html("NO DEPOSITS");if(a.comparedTo(0)>0){u=d-parseInt(a.toString(10)),c=Math.floor(u/3600),l=Math.floor(u%3600/60),h="HRS";1==c&&(h="HR"),c>0?$("#deposit_time_1000").html(c+" "+h+", "+l+" MINS AGO"):$("#deposit_time_1000").html(l+" MINS AGO")}else $("#deposit_time_1000").html("NO DEPOSITS")}).catch(e=>{console.log("An error occurred while pinging blockchain: "+JSON.stringify(e))})}function checkAllowance(){for(var e=0,t=$("#deposit_account").children("option:selected").val(),r=0;r<tokenList.length;r++)if(tokenList[r].units.toLowerCase()==t.toLowerCase()){e=r;break}var i=tokenList[e].token,o=padleftzero(userAddress.substring(2),64),n=padleftzero(proxyAddress.substring(2),64);if("none"==$("#deposit_action_buttons").css("display")&&"none"==$("#unlock_button").css("display")||1==$("#unlock_inner_button").prop("disabled")){const e=[{to:i,data:"0x"+contract_viewallowance+o+n},"latest"];ethereum.request({method:"eth_call",params:e}).then(e=>{var t=e.substring(2);new BigNumber("0x"+t.substring(0,64)).comparedTo(1)<0?$("#unlock_button").show():($("#unlock_button").hide(),$("#deposit_action_buttons").show(),matchColumnLength())}).catch(e=>{console.log("An error occurred while pinging blockchain: "+JSON.stringify(e))})}}function addWithdrawRequestBox(e,t,r,i,o,n,s,a){var d=e,u='<div class="withdraw_request_box" id="request_'+d+'" onclick=\'executeWithdraw("'+d+"\");'>";u+='<div class="withdraw_request_inner_left">&#x25A0;</div>',u+=o>0?'<div class="withdraw_request_inner_right" style="min-width: 150px;"><strong>YOUR COST:</strong><br>'+o+" ETH<br>GAS FEE</div>":'<div class="withdraw_request_inner_right" style="min-width: 150px;"><strong>YOUR COST:</strong><br>GAS FEE</div>';var c=new BigNumber(n);u+='<div class="withdraw_request_inner_right"><strong>YOUR REWARD:</strong><br>'+(c=new BigNumber(10).plus(c.minus(10).div(2))).dp(18).toString(10)+" "+s.toUpperCase()+"</div>",u+='<input type="hidden" id="request_'+d+'_proof" value="'+t+'">',u+='<input type="hidden" id="request_'+d+'_root" value="'+r+'">',u+='<input type="hidden" id="request_'+d+'_recipient" value="'+i+'">',u+='<input type="hidden" id="request_'+d+'_ethfee" value="'+o+'">',u+='<input type="hidden" id="request_'+d+'_reward" value="'+n+'">',u+='<input type="hidden" id="request_'+d+'_currency" value="'+s+'">',u+='<input type="hidden" id="request_'+d+'_amount" value="'+a+'">',u+="</div>",$("#request_container").append(u)}function loadWithdrawRequests(e){$("#request_next_page").length&&$("#request_next_page").remove(),$(".withdraw_request_box").length>0&&$(".withdraw_request_box").remove(),$.post(apiURL,{request_type:"view_requests",page:e},function(t){if(t&&void 0!==t.result){var r=t.result.length;if(0==r)0==e?$("#request_header").html("NO REQUESTS EXISTS"):($("#request_header").html("NO MORE REQUESTS"),$("#request_container").append('<span id="request_next_page" onclick="loadWithdrawRequests('+(e-1)+')" style="cursor: pointer;"><br>BACK PAGE</span>'));else{$("#request_header").html("COMPLETE THE WITHDRAW REQUESTS BELOW TO EARN THE REWARD");for(var i=0;i<r;i++){var o=t.result[i].nullifier_hash,n=t.result[i].currency,s=t.result[i].proof,a=t.result[i].root,d=t.result[i].recipient,u=new BigNumber(t.result[i].amount),c=new BigNumber(t.result[i].eth_fee),l=new BigNumber(t.result[i].reward);addWithdrawRequestBox(o,s,a,d,c.dp(18).toString(10),l.dp(18).toString(10),n,u.dp(18).toString(10))}r>=10&&$("#request_container").append('<span id="request_next_page" onclick="loadWithdrawRequests('+(e+1)+')" style="cursor: pointer;"><br>NEXT PAGE</span>')}}})}function refreshAccountData(){0==tokenList.length&&loadTokenList(),window.setTimeout(refreshAccountData,6e4),checkAllowance(),checkPoolInfo(),getEtherPrice(),getEthereumGasPrice()}function unlockAccount(){for(var e=0,t=$("#deposit_account").children("option:selected").val(),r=0;r<tokenList.length;r++)if(tokenList[r].units.toLowerCase()==t.toLowerCase()){e=r;break}var i=new BigNumber(2).pow(256).minus(1),o=proxyAddress.substring(2);o=padleftzero(o,64);var n=i.toString(16);n=padleftzero(n,64),sendETHTransaction([{to:tokenList[e].token,gas:"0x186A0",from:userAddress,data:"0x"+contract_approve+o+n}],function(){$("#unlock_inner_button").prop("disabled",!0),$("#unlock_inner_button").html("UNLOCKING "+tokenList[e].units+" TO DEPOSIT")})}function sendETHTransaction(e,t){0==new BigNumber("0x"+ethereum.chainId.substring(2)).comparedTo(targetNetwork)?ethereum.request({method:"eth_sendTransaction",params:e}).then(e=>{console.log("Transaction hash: "+e),t&&t()}).catch(e=>{console.log("An error occurred while pinging blockchain: "+JSON.stringify(e))}):alert("This application requires the main network, please switch it in your MetaMask UI.")}function setCookie(e,t,r){var i="";if(r>0){var o=new Date;o.setTime(o.getTime()+24*r*60*60*1e3),i="; expires="+o.toUTCString()}document.cookie=e+"="+(t||"")+i+"; path=/; SameSite=Strict"}function getCookie(e){for(var t=e+"=",r=document.cookie.split(";"),i=0;i<r.length;i++){for(var o=r[i];" "==o.charAt(0);)o=o.substring(1,o.length);if(0==o.indexOf(t))return o.substring(t.length,o.length)}return null}function eraseCookie(e){document.cookie=e+"=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;"}